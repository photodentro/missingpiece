<!doctype html> 
<!-- Copyright (C) 2018 Alkis Georgopoulos <alkisg@gmail.com>. License: GPLv3. -->
<html lang="el"> 
<head> 
  <meta charset="UTF-8" />
  <!-- Using this metatag users can't scale the page using pinchIn/out gestures on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <title>Συμπληρώστε τους πίνακες</title> 
  <script src="https://code.createjs.com/1.0.0/easeljs.min.js"></script>-->
  <style type="text/css">
    /* Remove margins and HTML scrollbars */
    body, html  {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background-color: black;
    }
    #mainCanvas {
    padding: 0;
    margin: auto;
    display: block;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    }
  </style>
</head>
<body onload = "init();">
  <canvas id="mainCanvas" width="320" height="180">
    Your browser doesn't support HTML5!
  </canvas>
<script>
  var stage;
  var bgShape;
  var statusText;
  var resourceNames = ["bar_help.svg","bar_home.svg", "bar_previous.svg", "bar_next.svg", "box.svg", "theofilosMA.png", "eggonopoulosMA.png", "ColorfulArchitecture.jpg", "TempleGardens.jpg"];
  var resourcesLoaded = 0;
  var resources = [];
  var ratio = 16/9;
  var winratio;
  var boxl;
  var boxr;
  var menubar = [];
  var lvlText = "1";
  var level = 0; 
  var contBg;
  var leftCont;
  var rightCont;
  var leftBox;
  var rightBox;
  var leftTextBox;
  var rightTextBox;
  var leftText;
  var rightText;  
  var lvlRows;
  var lvlColumns;
  var lvlPieces;
  var lvlPositions;
  var cil;
  var cir;
  var croppedWidth;
  var croppedHeight;

  function _distance(p1, p2) {
      var dx = p1.x - p2.x;
      var dy = p1.y - p2.y;
      return Math.sqrt(dx * dx + dy * dy);
  }


  function init(){
    console.clear();
    stage = new createjs.Stage("mainCanvas");
    stage.enableMouseOver();
    contBg = new createjs.Container();
    bgShape = new createjs.Shape();
    bgShape.graphics.beginFill("#444444").drawRect(0,0,stage.canvas.width,stage.canvas.height);
    contBg.addChild(bgShape);

    statusText = new createjs.Text("Φόρτωση...", "20px Arial", "black");
    statusText.textAlign = "center";
    statusText.textBaseline = "middle";
    contBg.addChild(statusText);
    resize();
    stage.addChild(contBg);  
    

    // Resource preloading
    for (var i = 0; i < resourceNames.length; i++) {

      resources[i] = new Image();
      resources[i].src = "resource/" + resourceNames[i];
      resources[i].onload = queueFileLoad;

    }
    // The last queueFileLoad calls queueComplete. Execution continues there.

  }

function imgByName(name) {
  return resources[resourceNames.indexOf(name)];
}

function queueFileLoad(event) {
  resourcesLoaded++;
  statusText.text = "Φόρτωση " + parseInt(100*resourcesLoaded/resourceNames.length) + " %";
  stage.update();
  if (resourcesLoaded == resourceNames.length)
    queueComplete(event);
}

function queueComplete(event) {
  console.log("Finished loading resources");

  var onMenuClick = [onMenuHelp, onMenuHome, onMenuPrevious, onMenuNext];
  for (i = 0; i < 4; i++) {

    menubar[i] = new createjs.Bitmap(resources[resourceNames.indexOf('bar_help.svg')+i]);
    menubar[i].addEventListener("click", onMenuClick[i]);
    menubar[i].addEventListener("mouseover", function(event) {
        // Bring the target on top in its container, mostly for the rotation animation
        event.target.parent.setChildIndex(event.target, event.target.parent.numChildren - 1);
        event.target.scaleX = 1.2*event.target.savedscaleX;
        event.target.scaleY = 1.2*event.target.savedscaleY;
        stage.update();});
    menubar[i].addEventListener("mouseout", function(event) {
        event.target.scaleX = event.target.savedscaleX;
        event.target.scaleY = event.target.savedscaleY;
        stage.update();});
    stage.addChild(menubar[i]);
    
  }
  lvlText = new createjs.Text("1", "20px Arial", "white");
  lvlText.textAlign = "center";
  lvlText.textBaseline = "middle";
  stage.addChild(lvlText);

  leftCont = new createjs.Container();
  leftBox = new createjs.Bitmap(imgByName("box.svg"));
  leftCont.addChild(leftBox);
  leftTextBox = new createjs.Shape();
  rightCont = new createjs.Container();
  rightBox = new createjs.Bitmap(imgByName("box.svg"));
  rightCont.addChild(rightBox);
  rightTextBox = new createjs.Shape();

  stage.update();
  initLevel(0);
  window.addEventListener('resize', resize, false);
  resize();
}

function initLevel(newLevel) {
  level = newLevel;
  lvlPieces = [{'rows':2,'columns':2},
    {'rows':5,'columns':5}];
  lvlImages = [['theofilosMA.png','eggonopoulosMA.png'],
    ['TempleGardens.jpg','ColorfulArchitecture.jpg']];
  lvlDesc = [['Ο Μέγας Αλέξανδρος\nΘεόφιλος Χατζημιχαήλ','Μέγας Αλέξανδρος και Παύλος Μελάς\nΝίκος Εγγονόπουλος'],
    ["Temple Gardens\nPaul Klee","Colorful Architecture\nPaul Klee"]];
  lvlPositions = [2,6];
  lvlRows = lvlPieces[newLevel]['rows'];
  lvlColumns = lvlPieces[newLevel]['columns'];
  lvlImageLeft = lvlImages[newLevel][0];
  lvlImageRight = lvlImages[newLevel][1];
  cil = cropImage(lvlImageLeft);
  cir = cropImage(lvlImageRight);
  leftText = new createjs.Text(lvlDesc[level][0],parseInt(stage.canvas.height/30) + 'px Arial', 'white');
  rightText = new createjs.Text(lvlDesc[level][1],parseInt(stage.canvas.height/30) + 'px Arial', 'white');

  //mark the missing pieces of the left side
  for (var i=0; i<lvlRows; i++){
    for (var j=0; j<lvlColumns; j++){
      cil[i][j].inPlace = true;
    }
  }
  for (var i=0; i<lvlPositions[level]/2; i++){
      var randomPieces = [];
      var randomPiece = Math.floor(Math.random()*lvlRows*lvlColumns);
      while (randomPieces.indexOf(randomPiece)>=0){
        randomPiece = Math.random(lvlRows*lvlColumns);
      }
      randomPieces.push(randomPiece);
      var randomRow = Math.floor(randomPiece / lvlColumns);
      var randomCol = randomPiece % lvlColumns;
      cil[randomRow][randomCol].inPlace = false;
      cil[randomRow][randomCol].origX = 600;
      cil[randomRow][randomCol].origY = 100;


      /*cil[randomRow][randomCol].origX = 2100/1200*stage.canvas.width + Math.random()*(258/1200*stage.canvas.width);
      cil[randomRow][randomCol].origY = 2*stage.canvas.height + Math.random()*(750/676*stage.canvas.height) - 750/676*stage.canvas.height;*/
      //possiblePositions.splice(aPosition,1);
  }

  //mark the missing pieces of the right side
  for (var i=0; i<lvlRows; i++){
    for (var j=0; j<lvlColumns; j++){
      cir[i][j].inPlace = true;
    }
  }
  for (var i=0; i<lvlPositions[level]/2; i++){
      var randomPieces = [];
      var randomPiece = Math.floor(Math.random()*lvlRows*lvlColumns);
      while (randomPieces.indexOf(randomPiece)>=0){
        randomPiece = Math.random(lvlRows*lvlColumns);
      }
      randomPieces.push(randomPiece);
      var randomRow = Math.floor(randomPiece / lvlColumns);
      var randomCol = randomPiece % lvlColumns;
      cir[randomRow][randomCol].inPlace = false;
      //var aPosition = Math.floor(Math.random()*possiblePositions.length);
      cir[randomRow][randomCol].origX = 600;
      cir[randomRow][randomCol].origY = 335;
      /*cir[randomRow][randomCol].origX = possiblePositions[aPosition]['x'];
      cir[randomRow][randomCol].origY = possiblePositions[aPosition]['y'];*/
      //possiblePositions.splice(aPosition,1);

  }

  resize();


}

function cropImage(imageName){
  //takes the image name and gives four cropped draggable objects
  
  croppedImages = [];
  for (var i=0; i<lvlRows; i++){
    croppedImages.push([]);
    for (var j=0; j<lvlColumns; j++){
      var croppedImage = new createjs.Bitmap(imgByName(imageName));
      croppedHeight = croppedImage.image.height/lvlRows;
      croppedWidth  = croppedImage.image.width /lvlColumns;
      croppedImage.sourceRect = new createjs.Rectangle(j*croppedWidth,i*croppedHeight,croppedWidth,croppedHeight);
      croppedImage.regX = croppedWidth/2;
      croppedImage.regY = croppedHeight/2;
      croppedImage.on('pressmove',function(e){
        stage.setChildIndex(e.target,stage.numChildren-1);
        if (!e.target.inPlace){
          e.target.x = e.stageX;
          e.target.y = e.stageY;
          stage.update();
        }
      });
      croppedImage.on('pressup',function(e){
          var curP = new createjs.Point(e.stageX,e.stageY);
          var tarP = new createjs.Point(e.target.correctX,e.target.correctY);
          var dist = _distance(curP,tarP);
          if (dist < stage.canvas.width/30){
            e.target.x = e.target.correctX;
            e.target.y = e.target.correctY;
            e.target.inPlace = true;
          }
          else{
            if (!e.target.inPlace){
            e.target.x = e.target.origX/1200*stage.canvas.width;
            e.target.y = e.target.origY/676*stage.canvas.height;
          }
          }
          stage.update();
        });
        croppedImage.croppedWidth = croppedWidth;
        croppedImage.croppedHeight = croppedHeight;
        croppedImages[croppedImages.length-1].push(croppedImage);
        }
  }
  return(croppedImages);
  }

function resize() {
  // Resize the canvas element
  winratio = window.innerWidth/window.innerHeight;
  if (winratio >= ratio) {
    stage.canvas.height = window.innerHeight;
    stage.canvas.width = stage.canvas.height * ratio;
  } else {
    stage.canvas.width = window.innerWidth;
    stage.canvas.height = stage.canvas.width / ratio;
  }
  // Fill all the canvas with the background
  
  var bgShape = new createjs.Shape();
  bgShape.graphics.beginFill('#444444').drawRect(0,0,stage.canvas.width,stage.canvas.height);
  contBg.addChild(bgShape);
  if (!menubar[0]) {
    statusText.x = stage.canvas.width / 2;
    statusText.y = stage.canvas.height / 2;
    statusText.font = parseInt(stage.canvas.height/10) + "px Arial";
    contBg.addChild(statusText);
    contBg.setChildIndex(statusText,contBg.numChildren - 1);
    statusText.visible = true;
    stage.update();
    return;
  }
  else{
    statusText.visible = false;
  }
 stage.addChild(contBg);



  var bbs = stage.canvas.height / 10;  // bar button size

  var bbm = bbs / 5;  // bar button margin
  // TODO: local/global variables, eslint...
  for (i = 0; i < 4; i++) {
    // Leave one space for the level
    if (i < 3)
      j = i;
    else
      j = i + 1;
    menubar[i].scaleX = bbs / menubar[i].image.width;
    menubar[i].scaleY = bbs / menubar[i].image.height;
    menubar[i].regX = menubar[i].image.width / 2;
    menubar[i].regY = menubar[i].image.height / 2;
    menubar[i].x = (j + 1)*bbm + bbs/2 + j*bbs;
    menubar[i].y = stage.canvas.height - bbm - bbs/2;
    menubar[i].visible = true;
    // These copies are used to preserve the original scale on mouseover
    menubar[i].savedscaleX = menubar[i].scaleX;
    menubar[i].savedscaleY = menubar[i].scaleY;
    stage.addChild(menubar[i]);
  }

  lvlText.text = level + 1;
  lvlText.x = (3 + 1)*bbm + bbs/2 + 3*bbs;
  lvlText.y = stage.canvas.height - bbm/2 - bbs/2;
  lvlText.font = parseInt(2*bbs/2) + "px Arial";
  stage.addChild(lvlText);


  leftCont.x = 40/1200*stage.canvas.width;
  leftCont.y = 30/676*stage.canvas.height;
  stage.addChild(leftCont);
  leftBox.x = 0;
  leftBox.y = 0;
  leftBox.scaleX = stage.canvas.width/1200;
  leftBox.scaleY = stage.canvas.height/676;
  leftCont.addChild(leftBox);
  leftTextBox.graphics.clear();
  leftTextBox.graphics.beginFill('#222222').drawRoundRect(0,470/676*stage.canvas.height, leftBox.image.width*leftBox.scaleX, 80/676*stage.canvas.height,stage.canvas.width/100);
  leftCont.addChild(leftTextBox);

  
  leftText.textAlign = "center";
  leftText.textBaseline = "middle";

  leftText.x = 214/1200*stage.canvas.width;
  leftText.y = 500/676*stage.canvas.height;
  leftText.font = parseInt(stage.canvas.height/30) + 'px Arial';
  leftCont.addChild(leftText);

  rightCont.x = 730/1200*stage.canvas.width;
  rightCont.y = 30/676*stage.canvas.height;
  stage.addChild(rightCont);
  rightBox.x = 0;
  rightBox.y = 0;
  rightBox.scaleX = stage.canvas.width/1200;
  rightBox.scaleY = stage.canvas.height/676;
  rightCont.addChild(rightBox);
  rightTextBox.graphics.clear();

  rightTextBox.graphics.beginFill('#222222').drawRoundRect(0,470/676*stage.canvas.height,rightBox.image.width*rightBox.scaleX,80/676*stage.canvas.height,stage.canvas.width/100);
  rightCont.addChild(rightTextBox);

  rightText.textAlign = "center";
  rightText.textBaseline = "middle";

  rightText.x = 214/1200*stage.canvas.width;
  rightText.y = 500/676*stage.canvas.height;
  rightText.font = parseInt(stage.canvas.height/30) + 'px Arial';
  rightCont.addChild(rightText);

  
  for (var i=0; i<lvlRows; i++){
    for (var j=0; j<lvlColumns; j++){
      var dw = 380*stage.canvas.width/1200;
      var dh = 400*stage.canvas.height/676;
      var scaleHor = dw/cil[i][j].image.width;
      var scaleVer = dh/cil[i][j].image.height;
      var sc = Math.min(scaleHor,scaleVer);
      cil[i][j].scaleX = sc;
      cil[i][j].scaleY = sc;
      cil[i][j].correctX = 1.5*leftCont.x + j*sc*(cil[i][j].croppedWidth)+sc*cil[i][j].croppedWidth/2 - 1;
      cil[i][j].correctY = 2*leftCont.y + i*sc*(cil[i][j].croppedHeight)+sc*cil[i][j].croppedHeight/2 - 1;
      if (cil[i][j].inPlace){
        cil[i][j].x = cil[i][j].correctX;
        cil[i][j].y = cil[i][j].correctY;
      }
      else{
        var marginX = cil[i][j].croppedWidth*sc/2;
        var marginY = cil[i][j].croppedHeight*sc/2;
        cil[i][j].x = cil[i][j].origX/1200*stage.canvas.width;
        cil[i][j].y = cil[i][j].origY/676*stage.canvas.height;
      }
      stage.addChild(cil[i][j]);
    }
  }





  for (var i=0; i<lvlRows; i++){
    for (var j=0; j<lvlColumns; j++){
      var dw = 380*stage.canvas.width/1200;
      var dh = 400*stage.canvas.height/676;
      var scaleHor = dw/cir[i][j].image.width;
      var scaleVer = dh/cir[i][j].image.height;
      var sc = Math.min(scaleHor,scaleVer);
      cir[i][j].scaleX = sc;
      cir[i][j].scaleY = sc;
      cir[i][j].correctX = rightCont.x + 0.5*leftCont.x + j*sc*(cir[i][j].croppedWidth)+sc*cir[i][j].croppedWidth/2 - 1;
      cir[i][j].correctY = rightCont.y + 1*leftCont.y + i*sc*(cir[i][j].croppedHeight)+sc*cir[i][j].croppedHeight/2 - 1;
      if (cir[i][j].inPlace){
        cir[i][j].x = cir[i][j].correctX;
        cir[i][j].y = cir[i][j].correctY;
      }
      else{
        cir[i][j].x = cir[i][j].origX/1200*stage.canvas.width;
        cir[i][j].y = cir[i][j].origY/676*stage.canvas.height;
      }
      stage.addChild(cir[i][j]);
    }
  }

  stage.update();
}


function onMenuHelp(event) {
  alert("Επιλέξτε εικόνες από το κάτω κουτί και βάλτε τις στο δεξί κουτί έτσι ώστε να ταιριάζουν με το αριστερό κουτί.");
}

function onMenuHome(event) {
  window.history.back();
}

function onMenuPrevious(event) {
  initLevel((level+lvlPieces.length - 1) % lvlPieces.length);
}

function onMenuNext(event) {
  initLevel((level+1) % lvlPieces.length);
}

</script>
</body>
</html>